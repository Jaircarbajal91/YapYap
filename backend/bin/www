#!/usr/bin/env node
// backend/bin/www

// Import environment variables
require("dotenv").config();
const { createServer } = require("http");
const { Server } = require("socket.io");
const { port } = require("../config");

const app = require("../app");

const server = createServer(app);
const io = new Server(server, {
	cors: {
		origin: "http://localhost:3000",
	},
});

// run this when a client connects
io.on("connection", socket => {
  // Listen for a new message
  socket.on("newMessage", message => {
    // Send the new message to all connected clients
    io.emit("message", message);
    console.log(message)
  });

});

const db = require("../db/models");

// Check the database connection before starting the app
db.sequelize
	.authenticate()
	.then(() => {
		console.log("Database connection success! Sequelize is ready to use...");

		// Start listening for connections
		server.listen(port, () =>
			console.log(`Server listening on port ${port}...`)
		);
		// app.listen(port, () => console.log(`Listening on port ${port}...`));
	})
	.catch(err => {
		console.log("Database connection failure.");
		console.error(err);
	});
